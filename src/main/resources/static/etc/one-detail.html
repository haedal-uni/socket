<!DOCTYPE html>
<th:block th:fragment="content">
	<div class="container">
		<div class="col-6">
			<h1 id="h1-text"></h1>
		</div>
		<div>
			<div id="msgArea" class="col"></div>
			<div class="col-6">
				<div class="input-group mb-3">
					<input type="text" id="msg" class="form-control">
					<div class="input-group-append">
						<button class="btn btn-outline-secondary" type="button" id="button-send">전송</button>
					</div>
				</div>
			</div>
		</div>
		<div class="col-6"></div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	<script src="http://code.jquery.com/jquery-latest.js"></script>
</th:block>    <!-- JavaScript -->
<script th:inline="javascript">
	$(document).ready(function() {
		let nickname = localStorage.getItem('wschat.sender')
		let roomId = localStorage.getItem('wschat.roomId')
		let roomName = localStorage.getItem('wschat.roomName')
		$("#h1-text").text(roomName)
		console.log(roomName + ", " + roomId + ", " + nickname);
		var sock = new SockJS("/ws/chat"); // Endpoint
		var ws = Stomp.over(sock); //1. SockJS를 내부에 들고있는 stomp를 내어줌
		//2. connection이 맺어지면 실행
		ws.connect({}, function() {
			console.log("STOMP Connection")
			//4. subscribe(path, callback)으로 메세지를 받을 수 있음
			ws.subscribe("/topic/chat/room/" + roomId, function(chat) {
				var content = JSON.parse(chat.body);
				var writer = content.sender;
				var message = content.message;
				var str = '';
				console.log("content :  " + JSON.stringify(content))
				console.log("content.type : " + content.type)
				if (content.type == "ENTER" || content.type == "QUIT") {
					str = "<div class='col-6'>";
					str += "<div class='alert alert-secondary' style='background-color: darkgrey'>";
					str += "<b>" + "[알림] : " + message + "</b>";
					str += "</div></div>";
				}
				if (content.type == "TALK") {
					if (writer === nickname) {
						str = "<div class='col-6'>";
						str += "<div class='alert alert-secondary' style='background-color: aliceblue'>";
						str += "<b>" + writer + " : " + message + "</b>";
						str += "</div></div>";
						//$("#msgArea").append(str);
					} else {
						str = "<div class='col-6'>";
						str += "<div class='alert alert-warning'style='background-color: cornsilk'>";
						str += "<b>" + writer + " : " + message + "</b>";
						str += "</div></div>";
					}
				}
				$("#msgArea").append(str);
			});
			//3. send(path, header, message)로 메세지를 보낼 수 있음
			ws.send("/app/chat/message", {}, JSON.stringify({type: 'ENTER', roomId: roomId, sender: nickname}));
		});
		$("#button-send").on("click", function(e) {
			var msg = document.getElementById("msg");
			console.log(nickname + ":" + msg.value);
			ws.send('/app/chat/message', {}, JSON.stringify({type: 'TALK', roomId: roomId, sender: nickname, message: msg.value,}));
			msg.value = '';
		});
	})
</script></html>